# executors

## 介绍
在性能的优化中，存在这样一种优化的手段，批处理，例如任务单独插入，每次需要和数据库交互，可以转为使用批量插入，这样可以减少数据库的交互次数，提高性能。

在 go-zero 中，executors 就是实现批处理的工具，充当任务池，做多任务缓冲。

## 使用
### 接口设计
在 executors 包下，有如下两类方法：
1. 具有特殊功能的 `delayexecutor`和 `LessExecutor`：
   1. `delayexecutor`：延迟函数执行
   2. `LessExecutor`：限定周期内只执行一次函数
2. 其余三个 `executor`，具体包括：
   1. `periodicalexecutor`：定期执行批处理
   2. `bulkexecutor`：在 `periodicalexecutor` 的基础上，除定期执行批处理外，还支持达到给定大小的任务数执行
   3. `chunkexecutor`：在 `periodicalexecutor` 的基础上，除定期执行批处理外，还支持达到指定字节数执行

### 使用
`periodicalexecutor`是`bulkexecutor`和`chunkexecutor`的基础，`periodicalexecutor`的使用分为三步：
1. 实现 container 接口 `TaskContainer`：
```go
// TaskContainer 接口定义了一个可以作为执行器的底层容器，用于周期性执行任务。
TaskContainer interface {
    // AddTask 将 task 加入容器中，当返回 true 时，调用 Execute 
    AddTask(task any) bool
    // Execute 执行 tasks
    Execute(tasks any)
    // RemoveAll 移除容器中的 tasks，并返回它们
    RemoveAll() any
}
```
`TaskContainer`接口中定义了三个方法，分别用于添加任务、执行任务和移除任务并返回。该接口中的方法最终会被`periodicalexecutor`所调用

```go
type InsertTask struct {
	tasks   []int
	execute executors.Execute
}

func newInsertTask(execute executors.Execute) *InsertTask {
    return &InsertTask{
        execute: execute,
    }
}

// AddTask 将任务添加到容器中，并返回一个布尔值来指示是否需要在添加后刷新容器
func (i *InsertTask) AddTask(task any) bool {
	i.tasks = append(i.tasks, task.(int))
	return len(i.tasks) >= 10
}

// Execute 刷新容器时处理收集的任务
func (i *InsertTask) Execute(tasks any) {
	vals := tasks.([]any)
	i.execute(vals)
}

// RemoveAll 移除并返回容器中的所有任务
func (i *InsertTask) RemoveAll() any {
	tasks := i.tasks
	i.tasks = nil
	return tasks
}
```
2. 实现 `Execute` 函数，这里只是打印
```go
// 函数定义
type Execute func(tasks []any)

execute := func(tasks []any) {
  fmt.Println("执行了")
  for _, task := range tasks {
      fmt.Println(task)
  }
}
```
传入全部的 tasks，在 `execute` 中进行批处理
3. 实例化 `periodicalexecutor`，并进行操作：
```go
exec := executors.NewPeriodicalExecutor(time.Millisecond*100, newInsertTask(execute))

defer exec.Wait()

for i := 10; i < 20; i++ {
  exec.Add(i)
}

exec.Flush()
```
- Add：将任务添加到容器中，当返回 true 时，调用 Execute
- Flush：将任务从容器取出，执行任务
- Wait：等待容器中的任务执行完毕

## 源码分析
此处主要分析 `periodicalexecutor`，其余两个 `executor` 都是依赖于这个的
### 执行流程概览图
